

/* timeline-view.js */
Exhibit.TimelineView=function(C,B){this._div=C;
this._uiContext=B;
this._settings={};
this._accessors={getEventLabel:function(F,E,D){D(E.getObject(F,"label"));
},getProxy:function(F,E,D){D(F);
},getColorKey:null,getIconKey:null};
this._selectListener=null;
this._largestSize=0;
var A=this;
this._listener={onItemsChanged:function(){A._reconstruct();
}};
B.getCollection().addListener(this._listener);
};
Exhibit.TimelineView._intervalChoices=["millisecond","second","minute","hour","day","week","month","year","decade","century","millennium"];
Exhibit.TimelineView._settingSpecs={"topBandHeight":{type:"int",defaultValue:75},"topBandUnit":{type:"enum",choices:Exhibit.TimelineView._intervalChoices},"topBandPixelsPerUnit":{type:"int",defaultValue:200},"bottomBandHeight":{type:"int",defaultValue:25},"bottomBandUnit":{type:"enum",choices:Exhibit.TimelineView._intervalChoices},"bottomBandPixelsPerUnit":{type:"int",defaultValue:200},"timelineHeight":{type:"int",defaultValue:400},"timelineConstructor":{type:"function",defaultValue:null},"colorCoder":{type:"text",defaultValue:null},"iconCoder":{type:"text",defaultValue:null},"selectCoordinator":{type:"text",defaultValue:null},"showHeader":{type:"boolean",defaultValue:true},"showSummary":{type:"boolean",defaultValue:true},"showFooter":{type:"boolean",defaultValue:true}};
Exhibit.TimelineView._accessorSpecs=[{accessorName:"getProxy",attributeName:"proxy"},{accessorName:"getDuration",bindings:[{attributeName:"start",type:"date",bindingName:"start"},{attributeName:"end",type:"date",bindingName:"end",optional:true}]},{accessorName:"getColorKey",attributeName:"marker",type:"text"},{accessorName:"getColorKey",attributeName:"colorKey",type:"text"},{accessorName:"getIconKey",attributeName:"iconKey",type:"text"},{accessorName:"getEventLabel",attributeName:"eventLabel",type:"text"},{accessorName:"getHoverText",attributeName:"hoverText",type:"text"}];
Exhibit.TimelineView.create=function(D,C,B){var A=new Exhibit.TimelineView(C,Exhibit.UIContext.create(D,B));
Exhibit.TimelineView._configure(A,D);
A._internalValidate();
A._initializeUI();
return A;
};
Exhibit.TimelineView.createFromDOM=function(D,C,B){var E=Exhibit.getConfigurationFromDOM(D);
var A=new Exhibit.TimelineView(C!=null?C:D,Exhibit.UIContext.createFromDOM(D,B));
Exhibit.SettingsUtilities.createAccessorsFromDOM(D,Exhibit.TimelineView._accessorSpecs,A._accessors);
Exhibit.SettingsUtilities.collectSettingsFromDOM(D,Exhibit.TimelineView._settingSpecs,A._settings);
Exhibit.TimelineView._configure(A,E);
A._internalValidate();
A._initializeUI();
return A;
};
Exhibit.TimelineView._configure=function(A,C){Exhibit.SettingsUtilities.createAccessors(C,Exhibit.TimelineView._accessorSpecs,A._accessors);
Exhibit.SettingsUtilities.collectSettings(C,Exhibit.TimelineView._settingSpecs,A._settings);
var B=A._accessors;
A._getDuration=function(F,E,D){B.getProxy(F,E,function(G){B.getDuration(G,E,D);
});
};
};
Exhibit.TimelineView.prototype.dispose=function(){this._uiContext.getCollection().removeListener(this._listener);
this._timeline=null;
if(this._selectListener!=null){this._selectListener.dispose();
this._selectListener=null;
}this._toolboxWidget.dispose();
this._toolboxWidget=null;
this._dom.dispose();
this._dom=null;
this._div.innerHTML="";
this._div=null;
this._uiContext.dispose();
this._uiContext=null;
};
Exhibit.TimelineView.prototype._internalValidate=function(){if("getColorKey" in this._accessors){if("colorCoder" in this._settings){this._colorCoder=this._uiContext.getExhibit().getComponent(this._settings.colorCoder);
}if(this._colorCoder==null){this._colorCoder=new Exhibit.DefaultColorCoder(this._uiContext);
}}if("getIconKey" in this._accessors){this._iconCoder=null;
if("iconCoder" in this._settings){this._iconCoder=this._uiContext.getExhibit().getComponent(this._settings.iconCoder);
}}if("selectCoordinator" in this._settings){var B=exhibit.getComponent(this._settings.selectCoordinator);
if(B!=null){var A=this;
this._selectListener=B.addListener(function(C){A._select(C);
});
}}};
Exhibit.TimelineView.prototype._initializeUI=function(){var A=this;
var B={};
B.colorGradient=(this._colorCoder!=null&&"_gradientPoints" in this._colorCoder);
B.iconMarkerGenerator=function(C){elmt=document.createElement("img");
elmt.src=C;
elmt.style.verticalAlign="middle";
return elmt;
};
this._div.innerHTML="";
this._dom=Exhibit.ViewUtilities.constructPlottingViewDom(this._div,this._uiContext,this._settings.showSummary&&this._settings.showHeader,{onResize:function(){A._timeline.layout();
}},B);
this._toolboxWidget=Exhibit.ToolboxWidget.createFromDOM(this._div,this._div,this._uiContext);
this._eventSource=new Timeline.DefaultEventSource();
this._reconstruct();
};
Exhibit.TimelineView.prototype._reconstructTimeline=function(L){var E=this._settings;
if(this._timeline!=null){this._timeline.dispose();
}if(L){this._eventSource.addMany(L);
}var Q=this._dom.plotContainer;
if(E.timelineConstructor!=null){this._timeline=E.timelineConstructor(Q,this._eventSource);
}else{Q.style.height=E.timelineHeight+"px";
Q.className="exhibit-timelineView-timeline";
var K=Timeline.ClassicTheme.create();
K.event.bubble.width=this._uiContext.getSetting("bubbleWidth");
K.event.bubble.height=this._uiContext.getSetting("bubbleHeight");
var I,M;
if(E.topBandUnit!=null||E.bottomBandUnit!=null){if(Exhibit.TimelineView._intervalLabelMap==null){Exhibit.TimelineView._intervalLabelMap={"millisecond":Timeline.DateTime.MILLISECOND,"second":Timeline.DateTime.SECOND,"minute":Timeline.DateTime.MINUTE,"hour":Timeline.DateTime.HOUR,"day":Timeline.DateTime.DAY,"week":Timeline.DateTime.WEEK,"month":Timeline.DateTime.MONTH,"year":Timeline.DateTime.YEAR,"decade":Timeline.DateTime.DECADE,"century":Timeline.DateTime.CENTURY,"millennium":Timeline.DateTime.MILLENNIUM};
}if(E.topBandUnit==null){M=Exhibit.TimelineView._intervalLabelMap[E.bottomBandUnit];
I=M-1;
}else{if(E.bottomBandUnit==null){I=Exhibit.TimelineView._intervalLabelMap[E.topBandUnit];
M=I+1;
}else{I=Exhibit.TimelineView._intervalLabelMap[E.topBandUnit];
M=Exhibit.TimelineView._intervalLabelMap[E.bottomBandUnit];
}}}else{var A=this._eventSource.getEarliestDate();
var H=this._eventSource.getLatestDate();
var O=H.getTime()-A.getTime();
var F=this._eventSource.getCount();
if(O>0&&F>1){var C=F/O;
var I=Timeline.DateTime.MILLENNIUM;
while(I>0){var G=Timeline.DateTime.gregorianUnitLengths[I];
var D=C*G/E.topBandPixelsPerUnit;
if(D<0.01){break;
}I--;
}}else{I=Timeline.DateTime.YEAR;
}M=I+1;
}var N=[Timeline.createBandInfo({width:E.topBandHeight+"%",intervalUnit:I,intervalPixels:E.topBandPixelsPerUnit,eventSource:this._eventSource,theme:K}),Timeline.createBandInfo({width:E.bottomBandHeight+"%",intervalUnit:M,intervalPixels:E.bottomBandPixelsPerUnit,eventSource:this._eventSource,overview:true,theme:K})];
N[1].syncWith=0;
N[1].highlight=true;
this._timeline=Timeline.create(Q,N,Timeline.HORIZONTAL);
}var P=this;
var B=function(R){if(P._selectListener!=null){P._selectListener.fire({itemIDs:[R]});
}};
for(var J=0;
J<this._timeline.getBandCount();
J++){this._timeline.getBand(J).getEventPainter().addOnSelectListener(B);
}};
Exhibit.TimelineView.prototype._reconstruct=function(){var O=this;
var a=this._uiContext.getCollection();
var M=this._uiContext.getDatabase();
var W=this._settings;
var Q=this._accessors;
var B=a.countRestrictedItems();
var Z=[];
this._dom.legendWidget.clear();
this._eventSource.clear();
if(B>0){var G=a.getRestrictedItems();
var D=(this._accessors.getColorKey!=null);
var F=(this._accessors.getIconKey!=null&&this._iconCoder!=null);
var K=(this._accessors.getHoverText!=null);
var H={mixed:false,missing:false,others:false,keys:new Exhibit.Set()};
var Y={mixed:false,missing:false,others:false,keys:new Exhibit.Set()};
var J=[];
var X=function(i,h,d,f,g){var e;
Q.getEventLabel(i,M,function(j){e=j;
return true;
});
var c=new Timeline.DefaultEventSource.Event(i,h.start,h.end,null,null,h.end==null,e,"",null,null,f,d,d,g);
c._itemID=i;
c.getProperty=function(j){return M.getObject(this._itemID,j);
};
c.fillInfoBubble=function(j,k,l){O._fillInfoBubble(this,j,k,l);
};
J.push(c);
};
G.visit(function(j){var h=[];
O._getDuration(j,M,function(i){if("start" in i){h.push(i);
}});
if(h.length>0){var d=null;
var k=null;
var e=null;
if(D){var l=new Exhibit.Set();
Q.getColorKey(j,M,function(i){l.add(i);
});
d=O._colorCoder.translateSet(l,H);
}var k=null;
if(F){var c=new Exhibit.Set();
Q.getIconKey(j,M,function(i){c.add(i);
});
k=O._iconCoder.translateSet(c,Y);
}if(K){var f=new Exhibit.Set();
Q.getHoverText(j,M,function(i){f.add(i);
});
for(var g in f._hash){e=g;
}}for(var g=0;
g<h.length;
g++){X(j,h[g],d,k,e);
}}else{Z.push(j);
}});
if(D){var T=this._dom.legendWidget;
var U=this._colorCoder;
var L=H.keys.toArray().sort();
if(this._colorCoder._gradientPoints!=null){T.addGradient(this._colorCoder._gradientPoints);
}else{for(var S=0;
S<L.length;
S++){var b=L[S];
var R=U.translate(b);
T.addEntry(R,b);
}}if(H.others){T.addEntry(U.getOthersColor(),U.getOthersLabel());
}if(H.mixed){T.addEntry(U.getMixedColor(),U.getMixedLabel());
}if(H.missing){T.addEntry(U.getMissingColor(),U.getMissingLabel());
}}if(F){var T=this._dom.legendWidget;
var C=this._iconCoder;
var L=Y.keys.toArray().sort();
if(W.iconLegendLabel!=null){T.addLegendLabel(W.iconLegendLabel,"icon");
}for(var S=0;
S<L.length;
S++){var b=L[S];
var V=C.translate(b);
T.addEntry(V,b,"icon");
}if(Y.others){T.addEntry(C.getOthersIcon(),C.getOthersLabel(),"icon");
}if(Y.mixed){T.addEntry(C.getMixedIcon(),C.getMixedLabel(),"icon");
}if(Y.missing){T.addEntry(C.getMissingIcon(),C.getMissingLabel(),"icon");
}}var I=B-Z.length;
if(I>this._largestSize){this._largestSize=I;
this._reconstructTimeline(J);
}else{this._eventSource.addMany(J);
}var N=this._timeline.getBand(0);
var E=N.getCenterVisibleDate();
var A=this._eventSource.getEarliestDate();
var P=this._eventSource.getLatestDate();
if(A!=null&&E<A){N.scrollToCenter(A);
}else{if(P!=null&&E>P){N.scrollToCenter(P);
}}}this._dom.setUnplottableMessage(B,Z);
};
Exhibit.TimelineView.prototype._select=function(B){var F=B.itemIDs[0];
var E=this._timeline.getBandCount();
for(var C=0;
C<E;
C++){var D=this._timeline.getBand(C);
var A=D.getEventSource().getEvent(F);
if(A){D.showBubbleForEvent(F);
break;
}}};
Exhibit.TimelineView.prototype._fillInfoBubble=function(A,B,C,D){this._uiContext.getLensRegistry().createLens(A._itemID,B,this._uiContext);
};
